{% extends "base.html" %}
{% load static %}

{% block content %}

<html>
<div class="alert alert-info alert-dismissible" role="alert">
  <button aria-label="Close" class="close" data-dismiss="alert" type="button"><span aria-hidden="true">×</span></button>
  <p>Welcome to the Beta version of the VIEW Blind Spot Calculator for Vehicles. This is not yet a fully functioning
    version of the site, however, it contains baseline features and functionality, including calculation of percent
    visibility from the driver’s seat. We look forward to receiving feedback about this version and look forward to
    the opportunity to grow and expand this site. Please contact alexander.epstein@dot.gov if your organization is
    interested in working with us, or if you have questions or feedback.</p>
</div>
<div class="jumbotron text-center">
  <div class="container">
    <h2><a href="/" style="color:white">VIEW: Blind Spot Calculator for
        Vehicles</a></h2>
  </div>
  <nav class="navbar navbar-default navbar-inverse">
    <div class="container">
      <ul class="nav navbar-nav">
        <li class="active">
          <a href="/" style="font-size:20px">Home</a>
        </li>
        <li class="active">
          <a href="/addvehicle" style="font-size:20px">Add Vehicle</a>
        </li>
        <li class="active">
          <a href="/getinfo" style="font-size:20px">Vehicle Database</a>
        </li>
      </ul>
    </div>
  </nav>
</div>
<div class="container">
  <div id="description" style="font-size:20px;">The Visibility in Elevated Wide vehicles (VIEW) app measures vehicles'
    percent visibility from the driver's seat.
    <!-- If webpage length is extended, use this to send user to the bottom of page when clicked:-->
    <!-- <a style="font-size:20px;" href="#bottom">Returning users: click to begin</a> -->
  </div>

  <hr>
  <div class="highlights">
    <div class="content">
      <a target="_blank" rel="noopener noreferrer"
        href="https://drive.google.com/file/d/1FOm7lByqzFiUMa-v9jwMK9gz54GIg3iC/view?usp=sharing">
        <img src="static/camera_ruler.jpg" style="max-width:70%;max-height:70%;" />
        <h3 target="_blank" rel="noopener noreferrer"
          href="https://drive.google.com/file/d/1FOm7lByqzFiUMa-v9jwMK9gz54GIg3iC/view?usp=sharing">Measurement
          Instructions <img src="static/new_tab.png" style="max-width:5%;max-height:5%;" />
      </a></h3>
      <p style="font-size:15px">Vehicle measurement and panoramic photo instructions.</p>
    </div>
    <div class="content">
      <a target="_blank" rel="noopener noreferrer"
        href="https://docs.google.com/presentation/d/1zag2zWmJqv0EjjDMW8ZKd5g_OLTlvjQ90cJEQmT9diQ/edit?usp=sharing">
        <img src="static/clipboard.png" style="max-width:38%;max-height:38%;" />
        <h3 target="_blank" rel="noopener noreferrer"
          href="https://docs.google.com/presentation/d/1zag2zWmJqv0EjjDMW8ZKd5g_OLTlvjQ90cJEQmT9diQ/edit?usp=sharing">
          Recording Sheet <img src="static/new_tab.png" style="max-width:5%;max-height:5%;" />
      </a></h3>
      <p style="font-size:15px">Print-off version of vehicle measurement sheet.</p>
    </div>
    <div class="content">
      <div class="youtube">
        <iframe class="responsive-iframe" src="https://www.youtube.com/embed/IYucUl6kP3w" frameborder="0"
          allow="autoplay; encrypted-media" allowfullscreen></iframe>
        <br></br>
        <br></br>
        <h3>How to Add a Vehicle</h3>
        <p style="font-size:15px">First time user video walkthrough of how to add a vehicle.</p>
      </div>
    </div>
  </div>
  <hr>
  <div id=choosepano class="unhidden" style="font-size:20px">Choose field of view panoramic image to upload:</div>
  <p id=loadmessage class="unhidden" style="font-size:15px">(Photo may take up to 10 seconds to load)</p>
  <div id="canvas" class="hidden" style="font-size:20px;">Click to draw<br /></div>
  <div id="measurementpole" class="hidden">
    <img src="static/measurement_pole.jpg" style="float:right;width:200px;height:300px" />
  </div>
  <br>
  <div id="steps" class="hidden">
    <div id="buttons" class="unhidden">
      <button class="btn btn-primary" onclick="backPanel()">Back</button>
      <button class="btn btn-primary" onclick="clearPanel()">Clear</button>
      <button class="btn btn-primary" onclick="nextPanel()">Next</button>
    </div>
    <div id="instructiontxt"></div>
    <hr>
    <div id="canvastips" class="hidden" style="font-size:20px;font-weight:bold">Marking Tips:
      <ul>
        <li style="font-weight:normal">Try to be as accurate as possible with your measurements and
          panoramic photo scan.</li>
        <li style="font-weight:normal">Turn phone horizontally for best results.</li>
        <li style="font-weight:normal">Pan/zoom in the white space outside of the image.</li>
      </ul>
    </div>
    <div id="dataentry" class="hidden">
      <form>
        <div class="form-group">
          <div id="vehiclemeasurements">
            <p>Vehicle measurements are shown in the image below.</p>
            <img src="static/vehiclemeasurements.jpg" style="vertical-align:middle;width:751px;height:547px" />
            </div>
            <br>
          <label for="h">Camera height (or driver's eye height) above ground in inches:</label>
          <input type="text" pattern="[0-9]*" class="form-control" id="dh" placeholder="Enter height eg: 63">
          <small id="radiusdescript" class="form-text text-muted">Measurement 'A' in reference image above.</small>
        </div>
        <div class="form-group">
          <label for="c">Distance from drivers's eye/camera to passenger window in inches:</label>
          <input type="text" pattern="[0-9]*" class="form-control" id="c" placeholder="Enter distance eg: 45">
          <small id="radiusdescript" class="form-text text-muted">Measurement 'B' in reference image above.</small>
        </div>
        <div class="form-group">
          <label for="r">Radial distance from driver to measurement stick in inches:</label>
          <input type="text" pattern="[0-9]*" class="form-control" id="rd" placeholder="Enter distance eg: 94">
          <small id="radiusdescript" class="form-text text-muted">Measurement 'C' in reference image above. This is not the
            hypotenuse, but the distance along the ground.</small>
        </div>
        <div class="form-group">
          <label for="d">Distance from driver's eye/camera to front bumper of vehicle in inches:</label>
          <input type="text" pattern="[0-9]*" class="form-control" id="d" placeholder="Enter distance eg: 84">
          <small id="radiusdescript" class="form-text text-muted">Measurement 'D' in reference image above.</small>
        </div>

      </form>
      <hr>
    </div>

    <h3>
      <div id="percentage">

      </div>
    </h3>

    <div id="vinfoentry" class="hidden">
      <form>
        <div class="form-group">
          <label for="selectvin" onclick="check1('selectvin')">VIN Number</label>
          <input type="radio" name="vinORnoVIN" id="selectvin" onclick="check1('selectvin')" />
        </div>
        <div class="form-group">
          <label for="selectnovin" onclick="check1('selectnovin')">Make, Model, Year, Weight Class</label>
          <input type="radio" name="vinORnoVIN" id="selectnovin" onclick="check1('selectnovin')" />
        </div>
      </form>
    </div>
    <div id="vinchoice" class="hidden">
      <form>
        <div class="form-group">
          <label for="vin">VIN Number:</label>
          <input type="text" class="form-control" id="vin" placeholder="Eg: 1C3CCBBGXCN287756">
        </div>
      </form>
    </div>
    <div id="novinchoice" class="hidden">
      <form>
        <div class="form-group">
          <label for="vmake">Vehicle Make:</label>
          <input type="text" class="form-control" id="vmake" placeholder="Eg: Ford">
        </div>
        <div class="form-group">
          <label for="vmodel">Vehicle Model:</label>
          <input type="text" class="form-control" id="vmodel" placeholder="Eg: F-150">
        </div>
        <!-- To select year from dropdown list: -->
        <div>
          <label for="vyear">Vehicle Year:</label>
          <select class="form-control chosen" id="vyear">
            <option selected>Please select a year</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
            <option value="2012">2012</option>
            <option value="2011">2011</option>
            <option value="2010">2010</option>
            <option value="2009">2009</option>
            <option value="2008">2008</option>
            <option value="2007">2007</option>
            <option value="2006">2006</option>
            <option value="2005">2005</option>
            <option value="2004">2004</option>
            <option value="2003">2003</option>
            <option value="2002">2002</option>
            <option value="2001">2001</option>
            <option value="2000">2000</option>
            <option value="1999">1999</option>
            <option value="1998">1998</option>
            <option value="1997">1997</option>
            <option value="1996">1996</option>
            <option value="1995">1995</option>
            <option value="1994">1994</option>
            <option value="1993">1993</option>
            <option value="1992">1992</option>
            <option value="1991">1991</option>
            <option value="1990">1990</option>
            <option value="1989">1989</option>
            <option value="1988">1988</option>
            <option value="1987">1987</option>
            <option value="1986">1986</option>
            <option value="1985">1985</option>
            <option value="1984">1984</option>
            <option value="1983">1983</option>
            <option value="1982">1982</option>
            <option value="1981">1981</option>
            <option value="1980">1980</option>
            <option value="1979">1979</option>
            <option value="1978">1978</option>
            <option value="1977">1977</option>
            <option value="1976">1976</option>
            <option value="1975">1975</option>
            <option value="1974">1974</option>
            <option value="1973">1973</option>
            <option value="1972">1972</option>
            <option value="1971">1971</option>
            <option value="1970">1970</option>
            <option value="1969">1969</option>
            <option value="1968">1968</option>
            <option value="1967">1967</option>
            <option value="1966">1966</option>
            <option value="1965">1965</option>
            <option value="1964">1964</option>
            <option value="1963">1963</option>
            <option value="1962">1962</option>
            <option value="1961">1961</option>
            <option value="1960">1960</option>
            <option value="1959">1959</option>
            <option value="1958">1958</option>
            <option value="1957">1957</option>
            <option value="1956">1956</option>
            <option value="1955">1955</option>
            <option value="1954">1954</option>
            <option value="1953">1953</option>
            <option value="1952">1952</option>
            <option value="1951">1951</option>
            <option value="1950">1950</option>
          </select>
        </div>
        <!-- To select weight class from dropdown list: -->
        <div>
          <label for="vwc">Vehicle Weight Class:</label>
          <select class="form-control chosen" id="vwc">
            <option selected>Please select a class</option>
            <option value="Class 1">Class 1: &lt;6,000 lbs</option>
            <option value="Class 2">Class 2: 6,001-10,000 lbs</option>
            <option value="Class 3">Class 3: 10,001-14,000 lbs</option>
            <option value="Class 4">Class 4: 14,001-16,000 lbs</option>
            <option value="Class 5">Class 5: 16,001-19,500 lbs</option>
            <option value="Class 6">Class 6: 19,501-26,000 lbs</option>
            <option value="Class 7">Class 7: 26,001-33,000 lbs</option>
            <option value="Class 8">Class 8: &gt;33,001 lbs</option>
          </select>
        </div>
      </form>
    </div>

    <div id="addcomments" class="hidden">
      <form>
        <div class="form-group">
          <label for="comments">Add comments:</label>
          <input type="text" class="form-control" id="comments" placeholder="Comments">
        </div>

      </form>
    </div>

    <div id="buttons2" class="hidden">
      <button class="btn btn-primary" onclick="backPanel()">Back</button>
      <button class="btn btn-primary" onclick="clearPanel()">Clear</button>
      <button class="btn btn-primary" onclick="nextPanel()">Next</button>
    </div>
  </div>
  <div id="uploadbutton" class="unhidden">
    <input type="file" style="font-size:15px" class="unhidden" onchange="previewFile()"><br>
  </div>
  <img src="" height="0" alt="">
  <hr>
  <h4 style="font-style:italic;font-size:13px;">This document is funded by the Santos Family Foundation and disseminated under the
    sponsorship of the Department of Transportation in the interest of information exchange. The United States
    Government assumes no liability for the contents or use thereof. The United States Government does not
    endorse products, manufacturers, or state or local policies or laws unless specifically indicated. Trade or
    manufacturers’ names may appear herein solely because they are considered essential to the objective of this
    document. Site contents represent the best technical judgement of U.S. DOT Volpe Center staff based on their
    independent and objective technical analysis and expertise, and are not to be misconstrued as statements of
    U.S. DOT policy or guidance.
</h4>


</div>
<!-- <div id="bottom"></div> -->

</html>

<script type="text/javascript">


  function clearPanel() {
    ctx.addClear(my_image);
  }

  function backPanel() {
    ctx.addBack(my_image);
  }

  function nextPanel() {
    ctx.addNext(my_image);
  }

  function check1(vinOrNoVIN) {
    if (vinOrNoVIN == "selectvin") {
      if (document.getElementById('vinchoice').className == 'hidden') {
        document.getElementById('vinchoice').className = "unhidden";
        document.getElementById('novinchoice').className = "hidden";
      }
    }
    else if (vinOrNoVIN == "selectnovin") {
      if (document.getElementById('novinchoice').className == 'hidden') {
        document.getElementById('novinchoice').className = "unhidden";
        document.getElementById('vinchoice').className = "hidden";
      }
    }
  }

  var color_marks = [];
  var curr_step = 1;
  var bottom_view_front = [];
  var bottom_view_passenger = [];
  var height_map = {};
  var neg_90;
  var zero;
  var angle_map = {};
  var driver_height; // the first val in the form
  var marks_dist; // the second val in the form
  var c; // the third val in the form
  var d; // the fourth val in the form
  var total_volume;
  var blind_volume = 0;
  var perc;
  var fileName; // the name of the image
  var comments; //any user-added comments

  function c(img) {
    // Creates a new canvas element and appends it as a child
    // to the parent element, and returns the reference to
    // the newly created canvas element

    function createCanvas(parent, width, height) {
      var canvas = {};
      canvas.node = document.createElement("canvas");
      canvas.context = canvas.node.getContext("2d");
      canvas.node.width = width || 100;
      canvas.node.height = height || 100;

      parent.appendChild(canvas.node);

      return canvas;
    }

    function storeCoordinate(xVal, yVal, array) {
      array.push({ x: xVal, y: yVal });
    }

    function storeOneCord(oVal, array) {
      array.push(oVal);
    }

    function getAverage(array) {
      var sum = 0;
      for (var i = 0; i < array.length; i++) {
        sum += parseInt(array[i], 10); //don't forget to add the base
      }
      var avg = sum / array.length;
      avg = Math.round(avg);
      return avg;
    }

    function init(container, width, height, fillColor) {
      var canvas = createCanvas(container, width, height);
      var coords = [];
      ctx = canvas.context;

      // define a custom fillCircle method
      ctx.fillCircle = function (x, y, radius, fillColor) {
        this.fillStyle = fillColor;
        this.beginPath();
        this.moveTo(x, y);
        this.arc(x, y, radius, 0, Math.PI * 2, false);
        this.fill();
      };

      ctx.addClear = function (img) {
        var image = new Image()
        image.onload = function () {
          coords = [];
          ctx.drawImage(image, 0, 0, width, height);
        }
        image.src = img

      }
      ctx.addClear(img);

      ctx.addBack = function (img) {
        curr_step = curr_step-1;
        var image = new Image()
        var item = document.getElementById("uploadbutton");
        if (item) {
          if (item.className == 'hidden') {
            item.className = 'unhidden';
          }
        }
        image.onload = function () {
          if (curr_step <= 5) { // right now we are accepting marks up to 6 feet
            var avg = getAverage(coords);
            color_marks.push(avg);
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): If the " + curr_step + " foot mark (M" + curr_step + ") is visible on the measurement pole, use your finger or your mouse to draw a small horizontal line on the mark. After making a line on the mark, hit next. If the mark is not visible, click next. Press clear if any errors are made.";
            var item = document.getElementById("canvastips");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            curr_step += 1;
          } else if (curr_step == 6) {
            var avg = getAverage(coords);
            color_marks.push(avg); // save color marks representing feet
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw a vertical line at 0 degrees (directly in front of the driver where the measuring stick was placed).";
            curr_step += 1;
          } else if (curr_step == 7) {
            var avg = getAverage(coords);
            zero = avg; // save zero degree point
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw vertical line at -90 degrees (directly to the right of the driver out of passenger window).";
            curr_step += 1;
          } else if (curr_step == 8) {
            var avg = getAverage(coords);
            neg_90 = avg; // save negative 90 degree point
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw line along the bottom of the front field of view.";
            curr_step += 1
          } else if (curr_step == 9) {
            bottom_view_front = coords;
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw line along the bottom of the passenger side field of view.";
            coords = [];
            curr_step += 1;
          } else if (curr_step == 10) {
            bottom_view_passenger = coords;
            var item = document.getElementById('buttons');
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById('buttons2');
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            var item = document.getElementById('dataentry');
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            var item = document.getElementById("canvas");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("measurementpole");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("canvastips");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("choosepano");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("loadmessage");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Enter vehicle measurements A, B, C, and D:";
            curr_step += 1;
          }
        }
        image.src = img
      }
      ctx.addBack(img);

      /*
          step instruction block, controls flow of user entered info
          data collected in each step is stored in the next because this is what happens after the
          user clicks next on that step
      */
      ctx.addNext = function (img) {
        var image = new Image()
        var item = document.getElementById("uploadbutton");
        if (item) {
          if (item.className == 'unhidden') {
            item.className = 'hidden';
          }
        }
        image.onload = function () {
          if (curr_step <= 5) { // right now we are accepting marks up to 6 feet
            var avg = getAverage(coords);
            color_marks.push(avg);
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): If the " + curr_step + " foot mark (M" + curr_step + ") is visible on the measurement pole, use your finger or your mouse to draw a small horizontal line on the mark. After making a line on the mark, hit next. If the mark is not visible, click next. Press clear if any errors are made.";
            var item = document.getElementById("canvastips");
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            curr_step += 1;
          } else if (curr_step == 6) {
            var avg = getAverage(coords);
            color_marks.push(avg); // save color marks representing feet
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw a vertical line at 0 degrees (directly in front of the driver where the measuring stick was placed).";
            curr_step += 1;
          } else if (curr_step == 7) {
            var avg = getAverage(coords);
            zero = avg; // save zero degree point
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw vertical line at -90 degrees (directly to the right of the driver out of passenger window).";
            curr_step += 1;
          } else if (curr_step == 8) {
            var avg = getAverage(coords);
            neg_90 = avg; // save negative 90 degree point
            coords = [];
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw line along the bottom of the front field of view.";
            curr_step += 1
          } else if (curr_step == 9) {
            bottom_view_front = coords;
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Draw line along the bottom of the passenger side field of view.";
            coords = [];
            curr_step += 1;
          } else if (curr_step == 10) {
            bottom_view_passenger = coords;
            var item = document.getElementById('buttons');
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById('buttons2');
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            var item = document.getElementById('dataentry');
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            var item = document.getElementById("canvas");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("measurementpole");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("canvastips");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("choosepano");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById("loadmessage");
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): Enter vehicle measurements A, B, C, and D:";
            curr_step += 1;
          } else if (curr_step == 11) {
            driver_height = Math.round(document.getElementById('dh').value, 0);
            marks_dist = Math.round(document.getElementById('rd').value, 0);
            c = Math.round(document.getElementById("c").value, 0);
            d = Math.round(document.getElementById("d").value, 0);
            createHeightMap();
            calcGroundIntersection();
            var item = document.getElementById('dataentry');
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            var item = document.getElementById('vinfoentry');
            if (item) {
              if (item.className == 'hidden') {
                item.className = 'unhidden';
              }
            }
            instructiontxt.innerHTML = "(Step " + curr_step + " of 11): In order to add to the vehicle database, would you like to add your vehicle using the VIN number, or the vehicle make, model, year, and weight class? (Choose one):";
            curr_step += 1;
          } else {//enter vin or vehicle info:
            var vin = document.getElementById('vin').value;
            if (vin.length == 0) {
              var vin = "NA";
              var partialvin = "NA";
              var vmake = document.getElementById('vmake').value;
              var vmodel = document.getElementById('vmodel').value;
              var vyear = document.getElementById('vyear').value;
              var vwc = document.getElementById('vwc').value;
              truckInfoNoVin(vin, partialvin, vmake, vmodel, vyear, vwc, perc, c, d, marks_dist, driver_height);
            } else {
              truckInfoFromVIN(vin, perc, c, d, marks_dist, driver_height);
            }
            instructiontxt.innerHTML = "Thank you. Your vehicle was added to the vehicle database. You can access the database on the 'Vehicle Database' page.";
            var item = document.getElementById('vinfoentry');
            if (item) {
              if (item.className == 'unhidden') {
                item.className = 'hidden';
              }
            }
            console.log("redirecting to getinfo page");
            location.href = '/getinfo';

          }
          ctx.drawImage(image, 0, 0, width, height);

        }
        image.src = img;

      }
      ctx.addNext(img);


      // bind mouse/finger events
      canvas.node.onpointermove = function (e) {
        if (!canvas.isDrawing) {
          return;
        }
        var x = e.pageX - this.offsetLeft;
        var y = e.pageY - this.offsetTop;
        var threshold = 5;
        if (y > height - threshold || x > width - threshold || x < threshold || y < threshold) {
          canvas.isDrawing = false;
        }
        var radius = 3; // or whatever
        var fillColor = '#ff0000';
        if (curr_step <= 6) {
          storeOneCord(y, coords);
        } else if (curr_step <= 8) {
          storeOneCord(x, coords);
        } else {
          storeCoordinate(x, y, coords);
        }
        ctx.fillCircle(x, y, radius, fillColor);
      };
      canvas.node.onpointerdown = function (e) {
        canvas.isDrawing = true;
        console.log(canvas);
      };
      canvas.node.onpointerup = function (e) {
        canvas.isDrawing = false;
      };
    }

    var container = document.getElementById('canvas');
    var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
    if (width < 1200) width = 1200;

    init(container, width * .75, width * .4, '#ddd', img);
  };

  /*
  previewFile displays the truck image
  */
  function previewFile() {
    // Where you will display your image
    var item = document.getElementById('canvas');
    if (item) {
      if (item.className == 'hidden') {
        item.className = 'unhidden';
      }
    }
    var item = document.getElementById('measurementpole');
    if (item) {
      if (item.className == 'hidden') {
        item.className = 'unhidden';
      }
    }
    var item = document.getElementById('steps');
    if (item) {
      if (item.className == 'hidden') {
        item.className = 'unhidden';
      }
    }
    var preview = document.querySelector('img');
    // The button where the user chooses the local image to display
    var file = document.querySelector('input[type=file]').files[0];
    console.log(file);
    console.log(file["name"]);
    fileName = file["name"];
    // FileReader instance
    var reader = new FileReader();

    // When the image is loaded we will set it as source of
    // our img tag
    reader.onloadend = function () {
      preview.src = reader.result;
      my_image = preview.src;
      c(preview.src);
    }

    if (file) {
      // Load image as a base64 encoded URI
      reader.readAsDataURL(file);

    } else {
      preview.src = "";
    }
  }

  /*
  createHeightMap creates a hashmap mapping pixel locations on the image to the height they
  correspond with at the radial distance the measurment stick is at

  */
  function createHeightMap() {
    for (var i = 0; i < color_marks.length; i++) {
      if (color_marks[i] & color_marks[i + 1]) {
        var diff = color_marks[i] - color_marks[i + 1];
        var increment = 12 / diff;
        var inches_val = i * 12;
        for (var j = color_marks[i]; j >= color_marks[i + 1]; j--) {
          height_map[j] = inches_val;
          inches_val += increment;
        }

      } else if (color_marks[i + 1] & color_marks[i + 2]) { // beginning of list
        var diff = color_marks[i + 1] - color_marks[i + 2];
        var increment = 12 / diff;
        var inches_val = (i - 9) * 12; // needed at the begining not the end because we increment up
        // we extend downward to handle all trucks
        for (var j = color_marks[i + 1] + (diff * 10); j >= color_marks[i + 1]; j--) {
          height_map[j] = inches_val;
          inches_val += increment;
        }
      } else if (color_marks[i]) { // end of the list
        var diff = color_marks[i - 1] - color_marks[i];
        var increment = 12 / diff;
        var inches_val = i * 12;
        // we extend upward to handle all trucks
        for (var j = color_marks[i]; j >= color_marks[i] - (diff * 5); j--) {
          height_map[j] = inches_val;
          inches_val += increment;
        }
      }
    }
    // console.log(height_map);
  }

  /*
  getPhi takes a x pixel location on the image and converts it to a radian value
  where 0 is directly in front of the driver as marked by the user

  px_x: the x pixel location
  */
  function getPhi(px_x) {
    var diff = zero - neg_90; // px difference between the angle marks
    var degree_v = diff / 90; // number of px each angle, 90 is diff angle size
    var past_zero = px_x - zero; // number of px off zero deg
    var deg = past_zero / degree_v;
    var radians = deg * (Math.PI / 180);
    return radians;
  }

  function getTanDeg(deg) {
    var rad = deg * Math.PI / 180;
    return Math.tan(rad);
  }

  function getATanDeg(deg) {
    return Math.atan(deg) * (180 / Math.PI);
  }

  /*
  Creates list of phis and nvps (ground intersection points) for both front and passenger views.
  Starts chain of requests initiated in each requests onload which
  end in the percentage visible area being displayed
  */
  function calcGroundIntersection() {
    var ground_intersections_front = [];
    var ground_intersections_passenger = [];
    var phis_front = [];
    var phis_passenger = [];

    // make lists of phis and nvps for front and passenger
    for (var i = 0; i < bottom_view_front.length; i++) {
      var bottom_view_inches = height_map[Math.round(bottom_view_front[i].y)];
      var opposite_side = driver_height - bottom_view_inches;
      var fov_angle = getATanDeg(opposite_side / marks_dist);
      var ground_intersection = driver_height * getTanDeg(90 - fov_angle);
      ground_intersections_front.push(ground_intersection);

      var phi = getPhi(bottom_view_front[i].x);
      phis_front.push(phi);
    }

    for (var i = 0; i < bottom_view_passenger.length; i++) {
      var bottom_view_inches = height_map[Math.round(bottom_view_passenger[i].y)];
      var opposite_side = driver_height - bottom_view_inches;
      var fov_angle = getATanDeg(opposite_side / marks_dist);
      var ground_intersection = driver_height * getTanDeg(90 - fov_angle);
      ground_intersections_passenger.push(ground_intersection);

      var phi = getPhi(bottom_view_passenger[i].x);
      phis_passenger.push(phi);
    }

    //remove any overlap in front and passenger window if it exists
    while (phis_front[phis_front.length - 1] <= phis_passenger[0]) {
      phis_front.pop()
      ground_intersections_front.pop()
    }
    calcBlindVolumeFront(ground_intersections_front, ground_intersections_passenger, phis_front, phis_passenger);
  }

  /*
  calcBlindVolumeFront makes a request to the getblindarea end point with the
  front window information, onload it calls calcBlindVolumePassenger

  ground_intersections_front: list(int), nearest visible points along the bottom of field of view from user drawn points along the front window
  ground_intersections_passenger: list(int), nearest visible points along the bottom of field of view from user drawn points along the passenger window
  phis_front: list(int), list of radians corresponding to ground_intersection_front
  phis_passenger: list(int), list of radians corresponding to ground_intersection_passenger
  */
  function calcBlindVolumeFront(ground_intersections_front, ground_intersections_passenger, phis_front, phis_passenger) {
    let request = new XMLHttpRequest();
    let url = "/api/v1/getblindarea/";
    request.responseType = "json";
    var headers = { 'content-type': 'application/json' };
    request.onload = function () {
      let response = this.response;
      console.log(response);
      blind_volume += response['data'];
      calcBlindVolumePassenger(ground_intersections_front, ground_intersections_passenger, phis_front, phis_passenger);
    }

    request.open("POST", url);
    request.send(body = JSON.stringify({ 'NVPs': ground_intersections_front, 'phis': phis_front, 'DH': driver_height, 'c': c, 'd': d }));
  }

  /*
  calcBlindVolumePassenger makes a request to the getblindarea end point with the
  passenger window information, onload it calls calcBlindVolumeBetween

  ground_intersections_front: list(int), nearest visible points along the bottom of field of view from user drawn points along the front window
  ground_intersections_passenger: list(int), nearest visible points along the bottom of field of view from user drawn points along the passenger window
  phis_front: list(int), list of radians corresponding to ground_intersection_front
  phis_passenger: list(int), list of radians corresponding to ground_intersection_passenger
  */
  function calcBlindVolumePassenger(ground_intersections_front, ground_intersections_passenger, phis_front, phis_passenger) {
    let request = new XMLHttpRequest();
    let url = "/api/v1/getblindarea/";
    request.responseType = "json";
    var headers = { 'content-type': 'application/json' };
    request.onload = function () {
      let response = this.response;
      console.log(response);
      blind_volume += response['data'];
      calcBlindVolumeBetween(phis_front, phis_passenger);
    }

    request.open("POST", url);
    request.send(body = JSON.stringify({ 'NVPs': ground_intersections_passenger, 'phis': phis_passenger, 'DH': driver_height, 'c': c, 'd': d }));
  }

  /*
  calcBlindVolumeBetween makes a request to the getinterestarea end point with the
  phi on either side of the barrier between the front and passenger window information, onload it calls calcTotalVolume

  phis_front: list(int), list of radians corresponding to ground_intersection_front
  phis_passenger: list(int), list of radians corresponding to ground_intersection_passenger
  */
  function calcBlindVolumeBetween(phis_front, phis_passenger) {
    //bookend_phis is the phis which bookend the blind area between the front and passenger window
    var bookend_phis = [phis_front[phis_front.length - 1], phis_passenger[0]];
    let request = new XMLHttpRequest();
    // getinterestarea is instead of getblindarea because want the entire slice
    // of area blocked
    let url = "/api/v1/getinterestarea/";
    request.responseType = "json";
    var headers = { 'content-type': 'application/json' };
    request.onload = function () {
      let response = this.response;
      console.log(response);
      blind_volume += response['data'];
      var phis = phis_front.concat(phis_passenger);
      calcTotalVolume(phis);
    }

    request.open("POST", url);
    request.send(body = JSON.stringify({ 'phis': bookend_phis, 'c': c, 'd': d }), headers = headers);
  }

  /*
  calcTotalVolume makes a request to the getinterestarea endpoint and onload calls postRatio()

  phis: list(int), list of all phis from both windows
  */
  function calcTotalVolume(phis) {
    let request = new XMLHttpRequest();
    let url = "/api/v1/getinterestarea/";
    request.responseType = "json";
    var headers = { 'content-type': 'application/json' };
    request.onload = function () {
      let response = this.response;
      console.log(response);
      total_volume = response['data'];
      postRatio();
    }

    request.open("POST", url);
    request.send(body = JSON.stringify({ 'phis': phis, 'c': c, 'd': d }), headers = headers);
  }

  /*
  Calculates the precentage visible volume and displays it
  */
  function postRatio() {
    console.log(total_volume);
    console.log(blind_volume);
    var ratio = (total_volume - blind_volume) / total_volume;
    var tperc = ratio * 100;
    var rounded_perc = Math.round(tperc, 0); // at this point we don't feel confident providing more percision
    percentage.innerHTML = "Percent of volume visible: " + rounded_perc + "%";
    console.log(ratio);
    perc = rounded_perc;
  }
  //Enter vehicle w/o vin # :

  function truckInfoNoVin(vin, partialvin, vmake, vmodel, vyear, vwc, perc, c, d, marks_dist, driver_height) {
    let request = new XMLHttpRequest();
    let url = "/api/v1/addvehicle/";
    var uvin = vin.toUpperCase();
    request.responseType = "json";
    var headers = { 'content-type': 'application/json' };

    request.onload = function () {
      let response = this.response;
      console.log(response);
      console.log("redirecting to getinfo page");
      // concat the user's perc_vis with the getinfo url to return custom getinfo page
      location.href = '/getinfo/' + perc;
    }
    request.open("POST", url, true);
    request.send(body = JSON.stringify({ 'vin': uvin, 'partialvin': partialvin, 'vmake': vmake, 'vmodel': vmodel, 'vwc': vwc, 'vyear': vyear, 'perc': perc, 'c': c, 'd': d, 'radial_distance': marks_dist, 'driver_height': driver_height, 'image_name': fileName }), headers = headers);
  }
  /*
  If user enters vin, truckInfoFromVIN gets truck model info to store in the database
  Uses the National Highway Traffic Saftey Administrations Product Informaton Catalog's API

  vin: string, either a ful or partial vehicle vin
  perc: int, the percentage visible area

  */
  function truckInfoFromVIN(vin, perc, c, d, marks_dist, driver_height) {
    // var vin = "5PVNC6JK562S10283"; // example
    let request = new XMLHttpRequest();
    var uvin = vin.toUpperCase();
    let url = "https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVINValues/" + uvin + "?format=json";

    request.onload = function () {
      if (this.readyState === 4 && this.status === 200) {
        let response = JSON.parse(this.responseText);
        getElements(response);
      }
    }

    request.open("GET", url, true);
    request.send();

    getElements = function (response) {
      console.log(response);
      var vmake = response["Results"]["0"]["Make"];
      var vmodel = response["Results"]["0"]["Model"];
      var vgvwr = response["Results"]["0"]["GVWR"];
      var vyear = response["Results"]["0"]["ModelYear"];
      var partialvin = uvin.substring(0, 10);
      var vwc = vgvwr.substring(0, 7);
      let request = new XMLHttpRequest();
      let url = "/api/v1/addvehicle/";
      request.responseType = "json";
      var headers = { 'content-type': 'application/json' };
      request.onload = function () {
        let response = this.response;
        console.log(response);
        console.log("redirecting to getinfo page");
        console.log(perc);
        // concat the user's perc_vis with the getinfo url to return custom getinfo page
        location.href = '/getinfo/' + perc;
      }

      request.open("POST", url);
      request.send(body = JSON.stringify({
        'vin': uvin, 'partialvin': partialvin, 'vmake': vmake,
        'vmodel': vmodel, 'vwc': vwc, 'vyear': vyear, 'perc': perc, 'c': c, 'd': d,
        'radial_distance': marks_dist, 'driver_height': driver_height,
        'image_name': fileName
      }), headers = headers);

    }
  }

</script>

{% endblock %}
